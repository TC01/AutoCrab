#!/usr/bin/env python

import optparse
import os
import shutil
import sys

# Commands that are a simple wrapper around a set of crab commands.
valid_commands = {	'create':'crab -create -submit -cfg ', 
					'status':'crab -status -get all -c ', 
					'resubmit':'crab -resubmit bad -c ', 
					'publish':'crab -publish -c '}

# Functions; should be spun off into another library.
def autocrabDelete(dir):
	config = getCrabConfig(dir)
	with open(config) as configFile:
		configText = config.read()
		remoteDir = configText[configText.find("user_remote_dir"):]
		remoteDir = remoteDir[remoteDir.find("="):].lstrip()
		# Hardcode /eos/uscms in here.
		remoteDir = os.path.join("/", "eos", "uscms", remoteDir)
		print remoteDir

valid_functions = {	'delete': autocrabDelete}

def getCrabConfig(dir):
	"""Retrieves backup copy of crab config file in directory."""
	path = os.path.join(dir, "share", "crab.cfg")
	return path

def isCrabDirectory(dir):
	"""Check if a directory is a working directory generated by crab."""
	isDirectory = True
	if not os.path.exists(os.path.join(dir, "job")):
		isDirectory = False
	if not os.path.exists(os.path.join(dir, "res")):
		isDirectory = False
	if not os.path.exists(os.path.join(dir, "log")):
		isDirectory = False
	if not os.path.exists(os.path.join(dir, "share")):
		isDirectory = False
	return isDirectory

def isCrabConfig(filename):
	"""Check if a file is a legal crab config file."""
	valid = False
	if ".cfg" in filename:
		valid = True

	configFile = open(filename)
	text = configFile.read()

	# Make sure we have the right blocks inside.
	if not ("[CRAB]" in text and "[CMSSW]" in text and "[USER]" in text):
		valid = False

	# Make sure we're not an autocrab template config file
	if "$INS_SHORTNAME" in text or "$INS_LONGNAME" in text:
		valid = False	

	return valid

def doAutoCrab(command):
	function = False
	crabline = ""
	if command in valid_commands.keys():
		crabline = valid_commands[command]
	elif command in valid_functions.keys():
		function = True

	# for now, use os.getcwd()
	for path, dirs, files in os.walk(os.getcwd()):
		if path != os.getcwd():
			continue

		if command == "create":
			for file in files:
				if not isCrabConfig(file):
					continue
				os.system(crabline + file)

		for dir in dirs:
			# Check if the inside is set up like a crab file.
			if not isCrabDirectory(os.path.join(path, dir)):
				continue
			if not function:
				os.system(crabline + dir)
			else:
				valid_functions[command](dir)

def main():
	parser = optparse.OptionParser()
	(opts, args) = parser.parse_args()

	for arg in args:
		if arg not in valid_commands.keys() and arg not in valid_functions.keys():
			print "Error: unrecognized autocrab command."
		else:
			doAutoCrab(arg)

if __name__ == '__main__':
	main()
